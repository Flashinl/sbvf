<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>StockBotVF</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-black text-green-100">
  <div class="max-w-5xl mx-auto px-4 py-8">
    <header class="mb-8 flex items-center justify-between text-green-300">
      <h1 class="text-2xl font-semibold">StockBotVF</h1>
      <a href="/health" class="text-sm text-gray-500 hover:text-gray-700">Health</a>
    </header>

    <section class="bg-neutral-900 shadow-sm rounded-xl border border-green-800 p-4 md:p-6">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
        <div class="relative">
          <label class="block text-sm font-medium text-gray-700 mb-1">Ticker</label>
          <input id="ticker" placeholder="AAPL" autocomplete="off" class="w-full rounded-lg border-green-700 bg-black text-green-100 focus:ring-2 focus:ring-green-500 focus:border-green-500" />
          <div id="suggestions" class="absolute left-0 right-0 mt-1 bg-neutral-900 border border-green-800 rounded-lg shadow-lg max-h-72 overflow-auto hidden z-10"></div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Risk</label>
          <select id="risk" class="w-full rounded-lg border-green-700 bg-black text-green-100 focus:ring-2 focus:ring-green-500 focus:border-green-500">
            <option value="low">Low</option>
            <option value="medium" selected>Medium</option>
            <option value="high">High</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Max News</label>
          <input id="max_news" type="number" min="0" max="25" value="8" class="w-full rounded-lg border-green-700 bg-black text-green-100 focus:ring-2 focus:ring-green-500 focus:border-green-500" />
        </div>
        <div class="flex items-end">
          <button id="analyzeBtn" class="w-full inline-flex items-center justify-center rounded-lg bg-green-600 text-black px-4 py-2 font-semibold hover:bg-green-500 focus:outline-none focus:ring-2 focus:ring-green-500">
            Analyze
          </button>
        </div>
      </div>
    </section>

    <section id="featured" class="mt-8">
      <h2 class="text-lg font-semibold mb-3 text-green-400">Featured Today</h2>
      <div id="featuredGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </section>


    <section id="results" class="mt-6 hidden">
      <div id="rec" class="mb-6 p-4 rounded-xl border border-green-800 bg-neutral-900"></div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

        <div id="technicals" class="p-4 rounded-xl border border-green-800 bg-neutral-900"></div>
        <div id="news" class="p-4 rounded-xl border border-green-800 bg-neutral-900 md:col-span-1"></div>
      </div>
    </section>

    <section id="loading" class="mt-6 hidden">
      <div class="animate-pulse p-4 rounded-xl border border-green-800 bg-neutral-900 text-green-500">Running analysis…</div>
    </section>

    <section id="error" class="mt-6 hidden">
      <div class="p-4 rounded-xl border border-red-700 bg-red-950 text-red-300"></div>
    </section>


  </div>

  <script>
    const el = (id) => document.getElementById(id);
    const fmt = new Intl.NumberFormat(undefined, { maximumFractionDigits: 2 });


    // --- Autocomplete (Yahoo search) ---
    function debounce(fn, ms){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); }; }
    async function fetchSuggestions(q){
      const res = await fetch(`https://query1.finance.yahoo.com/v1/finance/search?q=${encodeURIComponent(q)}&quotesCount=6&lang=en-US`);
      if(!res.ok) return [];
      const j = await res.json();
      return (j.quotes||[]).map(q=>({ symbol: q.symbol, name: q.shortname || q.longname || q.symbol, exchange: q.exchDisp || '' }));
    }
    function renderSuggestions(items){
      const box = el('suggestions');
      if(!items.length){ box.classList.add('hidden'); box.innerHTML=''; return; }
      box.innerHTML = items.map(it=>
        `<div data-symbol="${it.symbol}" class="px-3 py-2 hover:bg-neutral-800 cursor-pointer flex items-center justify-between">
           <div><span class="font-semibold text-green-200 mr-2">${it.symbol}</span><span class="text-green-500 text-sm">${it.name}</span></div>
           <div class="text-xs text-green-600">${it.exchange}</div>
         </div>`
      ).join('');
      box.classList.remove('hidden');
      box.querySelectorAll('[data-symbol]').forEach(node=>{
        node.addEventListener('click', ()=>{ el('ticker').value = node.getAttribute('data-symbol'); box.classList.add('hidden'); });
      });
    }
    function setupSuggestions(){
      const input = el('ticker');
      const box = el('suggestions');
      const runSuggest = debounce(async ()=>{
        const q = input.value.trim();
        if(q.length < 1){ box.classList.add('hidden'); box.innerHTML=''; return; }
        try{ const items = await fetchSuggestions(q); renderSuggestions(items); } catch{ box.classList.add('hidden'); }
      }, 200);
      input.addEventListener('input', runSuggest);
      input.addEventListener('focus', runSuggest);
      document.addEventListener('click', (e)=>{ if(!box.contains(e.target) && e.target !== input){ box.classList.add('hidden'); } });
    }

    // --- Featured tickers homepage ---
    const featuredTickers = ['AAPL','MSFT','NVDA','TSLA','AMZN','META','GOOGL','SPY','QQQ'];
    async function loadFeatured(){
      const grid = el('featuredGrid');
      grid.innerHTML = featuredTickers.map(sym=>
        `<div id="card-${sym}" class="p-4 rounded-xl border border-green-800 bg-neutral-900">
           <div class="text-sm text-green-500">${sym}</div>
           <div class="h-6 animate-pulse bg-neutral-800 rounded w-1/2 my-2"></div>
           <div class="h-4 animate-pulse bg-neutral-800 rounded w-2/3"></div>
         </div>`
      ).join('');
      for(const sym of featuredTickers){
        try{
          const res = await fetch(`/analyze?ticker=${encodeURIComponent(sym)}&risk=medium&max_news=3&timeout=180`);
          const data = await res.json();
          if(res.ok){ renderFeaturedCard(sym, data); }
          else{ renderFeaturedError(sym, data.error || 'Unavailable'); }
        }catch(err){ renderFeaturedError(sym, 'Unavailable'); }
      }
    }
    function renderFeaturedCard(sym, data){
      const r = data.recommendation || {};
      const price = data.price?.price;
      const badge = (lbl)=>{ const map = { Buy: 'bg-green-600 text-black', Hold: 'bg-neutral-700 text-green-200', Sell: 'bg-red-600 text-white' }; return `<span class=\"px-2 py-0.5 rounded text-xs ${map[lbl]||'bg-neutral-700'}\">${lbl||'\u2014'}</span>`; };
      const html = `
        <div class=\"flex items-center justify-between\">
          <div>
            <div class=\"text-sm text-green-500\">${sym}</div>
            <div class=\"text-xl font-semibold text-green-300\">$${price!=null? fmt.format(price):'-'} ${badge(r.label)}</div>
          </div>
          <div class=\"text-sm text-green-500\">${fmt.format(r.confidence||0)}%</div>
        </div>
        <div class=\"text-sm text-green-200 mt-2 line-clamp-3\">${(r.ai_analysis||'').slice(0,160)}${(r.ai_analysis||'').length>160?'\u2026':''}</div>`;
      const card = document.getElementById(`card-${sym}`);
      if(card) card.innerHTML = html;
    }
    function renderFeaturedError(sym, msg){
      const card = document.getElementById(`card-${sym}`);
      if(card) card.innerHTML = `<div class=\"text-sm text-green-500 mb-1\">${sym}</div><div class=\"text-sm text-green-600\">${msg}</div>`;
    }

    function card(title, rowsHtml) {
      return `<h2 class=\"text-lg font-semibold mb-3 text-green-400\">${title}</h2><div class=\"space-y-1 text-sm\">${rowsHtml}</div>`;
    }

    function row(label, value) {
      return `<div class=\"flex justify-between\"><span class=\"text-green-500\">${label}</span><span class=\"font-semibold text-green-200\">${value ?? '-'}</span></div>`;
    }

    // Init homepage + suggestions
    document.addEventListener('DOMContentLoaded', ()=>{ setupSuggestions(); loadFeatured(); });

    async function run() {
      el('error').classList.add('hidden');
      el('results').classList.add('hidden');
      el('loading').classList.remove('hidden');

      const ticker = el('ticker').value.trim() || 'AAPL';
      const risk = el('risk').value;
      const max_news = Math.max(0, Math.min(25, parseInt(el('max_news').value || '8', 10)));

      try {
        const url = `/analyze?ticker=${encodeURIComponent(ticker)}&risk=${encodeURIComponent(risk)}&max_news=${max_news}&timeout=240`;
        const res = await fetch(url);
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || res.statusText);

        // Recommendation
        const r = data.recommendation || {};
        el('rec').innerHTML = `
          <div class=\"flex items-center justify-between\">
            <div>
              <div class=\"text-sm text-green-500\">${data.price?.ticker || ticker}</div>
              <div class=\"text-2xl font-semibold text-green-400\">${r.label || '—'} <span class=\"text-green-500 text-base\">(${fmt.format(r.confidence || 0)}%)</span></div>
            </div>
            <div class=\"text-2xl font-semibold text-green-300\">$${fmt.format(data.price?.price)}</div>
          </div>
          <p class=\"text-sm text-green-200 mt-2\">${(r.ai_analysis || r.rationale || '').split('\n').map(x=>`<span class=\"block\">${x}</span>`).join('')}</p>`;


        // Technicals
        const t = data.technicals || {};
        const rows = [];
        const pushRow = (label, value) => {
          if (value !== null && value !== undefined && value !== '-' && value !== '') {
            rows.push(row(label, value));
          }
        };
        pushRow('Price', data.price?.price ? `$${fmt.format(data.price.price)}` : null);
        pushRow('SMA20', t.sma20);
        pushRow('SMA50', t.sma50);
        pushRow('SMA200', t.sma200);
        pushRow('RSI(14)', t.rsi14);
        pushRow('Trend Score', t.trend_score);
        pushRow('52W High', data.price?.fifty_two_week_high);
        pushRow('52W Low', data.price?.fifty_two_week_low);
        el('technicals').innerHTML = rows.length
          ? card('Technical Stats', rows.join(''))
          : card('Technical Stats', '<div class="text-sm text-green-500">No technical data</div>');

        // News
        const list = (data.news || []).slice(0, 10).map(n => `
          <a href=\"${n.url}\" target=\"_blank\" class=\"block p-3 rounded-lg border border-green-800 hover:bg-neutral-800\">
            <div class=\"text-sm text-green-500\">${n.source}</div>
            <div class=\"font-medium\">${n.title}</div>
            <div class=\"text-sm text-green-500\">Sentiment: ${fmt.format((n.sentiment || 0) * 100)}%</div>
          </a>`).join('');
        el('news').innerHTML = `<h2 class=\"text-lg font-semibold mb-3\">Recent News</h2><div class=\"space-y-2\">${list || '<div class=\"text-sm text-gray-500\">No recent headlines</div>'}</div>`;

        el('loading').classList.add('hidden');
        el('results').classList.remove('hidden');
      } catch (e) {
        el('loading').classList.add('hidden');
        el('error').classList.remove('hidden');
        el('error').firstElementChild.textContent = e.message || String(e);
      }
    }

    el('analyzeBtn').addEventListener('click', run);
    // Default ticker
    el('ticker').value = 'AAPL';
  </script>
</body>
</html>

